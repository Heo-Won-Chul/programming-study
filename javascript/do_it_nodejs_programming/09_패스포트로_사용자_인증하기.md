# 패스포트로 로그인하기

- http://passportjs.org/docs
- 노드애서 사용할 수 있는 `사용자 인증 모듈`이다.
- 간단하고, 인증 기능을 독립된 모듈 안에서 진행할 수 있도록 도와준다.
- 미들웨어로 끼워넣을 수 있어 간단한 설정만으로 로그인 기능을 만들 수 있다,
- 순전히 __인증 기능만 담당__ 한다.

- 수백 가지의 인증 방식 제공한다. (전략 방식으로 어떤 인증 방식을 사용할지 결정한다.)
- 대표적으로는 데이터베이스 정보와 비교하는 `로컬 인증 방식`, SNS 계정을 사용하능 `OAuth 인증 방식`이 있다.

- 인증한 후 성공하면 사용자 정보를 __세션에 저장__ 한다.

### 패스포트의 기본 사용 방법 살펴보기

- passport 모듈 설치

```text
> npm install body-parser --save
> npm install passport --save
```

- 라우팅 함수를 등록하는 코드에 `passport.authenticate()`를 호출 한다.
- `local`은 데이터베이스에 정보와 비교하는 `로컬 인증 방식`을 사용한다.

```javascript
// ...
app.post('/login', passport.authenticate('local')));
// ...
```

- 인증 실패시, 디폴트 값으로 __401 Unauthorized__ 응답을 보낸다.
- 인증 성공시, 다음 라우팅 함수가 호출되며, `req.user`에 인증된 사용자 정보가 들어간다.
- 인증 여부에 따라, 리다이렉트 시킬 수 있다.

```javascript
// ...
app.post('/login', passport.authenticate('local', {
          successRedirect: '/',
          failureRedirect: '/login'
      }));
// ...
```

### 플래시 메시지와 커스텀 콜백 이해하기

- 리다이렉트를 사용하여 응답을 보낼 때는 보통 `플래시 메시지`를 같이 사용한다.

```text
> npm install connect-flash --save
```

```javascript
// ...
app.post('/login', passport.authenticate('local', {
          failureFlash: true
      }));
// ...
```

- 별도의 __콜백 함수__ 가 필요하다면, 다음과 같이 진행할 수 있다.

```javascript
// ...
router.route('/login').post((req, res, next) => {
    passport.authenticate('local', (err, user, unfo) => {
        if (err) {
            return next(err);
        }
        if (!user) {
            return res.redirect('/login');
        }

        req.logIn(user, function(err) {
            if (err) {
                return next(err);
            }
            return res.redirect('/users/' + user.username);
        });
    });
});
// ...
```

### 스트래지티 설정과 검증 콜백

- 여러가지 인증 방식 지원한다.
- 인증에 대한 스트래지티가 설정되어 있어야 한다. (`passport.use()` 설정)
- `로컬 인증 방식`의 경우는 `passport-local 모듈`이 설치해야 한다.

```text
> npm install passport-local --save
```
